<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HugeCTR Wide and Deep Model with Criteo &mdash; Merlin HugeCTR  documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.css" type="text/css" />
      <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="canonical" href="https://nvidia-merlin.github.io/HugeCTR/main/notebooks/hugectr_wdl_prediction.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script >let toggleHintShow = 'Click to show';</script>
        <script >let toggleHintHide = 'Click to hide';</script>
        <script >let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="NVIDIA Merlin on Microsoft’s News Dataset (MIND)" href="news-example.html" />
    <link rel="prev" title="HugeCTR Continuous Training" href="continuous_training.html" /> 
</head>

<body class="wy-body-for-nav">
  <div class="banner">
    <p class="banner">
      Beginning in January 2023, versions for all NVIDIA Merlin projects
      will change from semantic versioning like <code>4.0</code>
      to calendar versioning like <code>23.01</code>.</p>
  </div>

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Merlin HugeCTR
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">HUGECTR</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../hugectr_user_guide.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hugectr_core_features.html">Core Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hugectr_embedding_training_cache.html">Embedding Training Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hierarchical_parameter_server/index.html">Hierarchical Parameter Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparse_operation_kit.html">Sparse Operation Kit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance.html">Performance</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Example Notebooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ecommerce-example.html">Merlin ETL, training, and inference with e-Commerce behavior data</a></li>
<li class="toctree-l2"><a class="reference internal" href="movie-lens-example.html">HugeCTR demo on Movie lens data</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugectr_criteo.html">Introduction to the HugeCTR Python Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugectr2onnx_demo.html">HugeCTR to ONNX Converter</a></li>
<li class="toctree-l2"><a class="reference internal" href="continuous_training.html">HugeCTR Continuous Training</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">HugeCTR Wide and Deep Model with Criteo</a></li>
<li class="toctree-l2"><a class="reference internal" href="news-example.html">NVIDIA Merlin on Microsoft’s News Dataset (MIND)</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_gpu_offline_inference.html">Multi-GPU Offline Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="hps_demo.html">Hierarchical Parameter Server Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="training_and_inference_with_remote_filesystem.html">HugeCTR Training and Inference with Remote File System Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="embedding_training_cache_example.html">Embedding Training Cache Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="embedding_collection.html">HugeCTR Embedding Collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugectr_e2e_demo.html">HugeCTR End-end Example with NVTabular</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="multi-modal-data/index.html">Multi-modal Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional_resources.html">Additional Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hugectr_contributor_guide.html">Contributing to HugeCTR</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Merlin HugeCTR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">HugeCTR Example Notebooks</a></li>
      <li class="breadcrumb-item active">HugeCTR Wide and Deep Model with Criteo</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copyright 2021 NVIDIA Corporation. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ==============================================================================</span>

<span class="c1"># Each user is responsible for checking the content of datasets and the</span>
<span class="c1"># applicable licenses and determining if suitable for the intended use.</span>
</pre></div>
</div>
</div>
</div>
<img alt="http://developer.download.nvidia.com/notebooks/dlsw-notebooks/merlin_hugectr_hugectr-wdl-prediction/nvidia_logo.png" src="http://developer.download.nvidia.com/notebooks/dlsw-notebooks/merlin_hugectr_hugectr-wdl-prediction/nvidia_logo.png" />
<div class="tex2jax_ignore mathjax_ignore section" id="hugectr-wide-and-deep-model-with-criteo">
<h1>HugeCTR Wide and Deep Model with Criteo<a class="headerlink" href="#hugectr-wide-and-deep-model-with-criteo" title="Permalink to this headline"></a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>In this notebook, we provide a tutorial that shows how to train a wide and deep model using the high-level Python API from HugeCTR on the original Criteo dataset as training data.
We show how to produce prediction results based on different types of local database.</p>
</div>
<div class="section" id="setup-hugectr">
<h2>Setup HugeCTR<a class="headerlink" href="#setup-hugectr" title="Permalink to this headline"></a></h2>
<p>To setup the environment, refer to <a class="reference internal" href="index.html"><span class="xref myst">HugeCTR Example Notebooks</span></a> and follow the instructions there before running the following.</p>
</div>
<div class="section" id="dataset-preprocessing">
<h2>Dataset Preprocessing<a class="headerlink" href="#dataset-preprocessing" title="Permalink to this headline"></a></h2>
<div class="section" id="generate-training-and-validation-data-folders">
<h3>Generate training and validation data folders<a class="headerlink" href="#generate-training-and-validation-data-folders" title="Permalink to this headline"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define some data folder to store the original and preprocessed data</span>
<span class="c1"># Standard Libraries</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="s2">&quot;/wdl_train&quot;</span>
<span class="n">train_path</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">val_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)</span>
<span class="n">CUDA_VISIBLE_DEVICES</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
<span class="n">n_workers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">CUDA_VISIBLE_DEVICES</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
<span class="n">frac_size</span> <span class="o">=</span> <span class="mf">0.15</span>
<span class="n">allow_multi_gpu</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">use_rmm_pool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">max_day</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (Optional) -- Limit the dataset to day 0-max_day for debugging</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">train_path</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">train_path</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">train_path</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">val_path</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">val_path</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">val_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>ls<span class="w"> </span>-l<span class="w"> </span><span class="nv">$train_path</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>total 0
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="download-the-original-criteo-dataset">
<h3>Download the original Criteo dataset<a class="headerlink" href="#download-the-original-criteo-dataset" title="Permalink to this headline"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>apt-get<span class="w"> </span>install<span class="w"> </span>wget
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>wget<span class="w"> </span>-P<span class="w"> </span><span class="nv">$train_path</span><span class="w"> </span>https://storage.googleapis.com/criteo-cail-datasets/day_0.gz
</pre></div>
</div>
</div>
</div>
<p>Split the dataset into training and validation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!gzip -d -c $train_path/day_0.gz &gt; day_0</span>
<span class="o">!</span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">45840617</span><span class="w"> </span>day_0<span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$train_path</span>/train.txt
<span class="o">!</span>tail<span class="w"> </span>-n<span class="w"> </span><span class="m">2000000</span><span class="w"> </span>day_0<span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$val_path</span>/test.txt<span class="w"> </span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="preprocessing-with-nvtabular">
<h3>Preprocessing with NVTabular<a class="headerlink" href="#preprocessing-with-nvtabular" title="Permalink to this headline"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> /wdl_train/preprocess.py
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">import</span> <span class="nn">dask_cudf</span>
<span class="kn">from</span> <span class="nn">dask_cuda</span> <span class="kn">import</span> <span class="n">LocalCUDACluster</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>

<span class="kn">import</span> <span class="nn">cudf</span>
<span class="kn">import</span> <span class="nn">rmm</span>
<span class="kn">import</span> <span class="nn">nvtabular</span> <span class="k">as</span> <span class="nn">nvt</span>
<span class="kn">from</span> <span class="nn">nvtabular.io</span> <span class="kn">import</span> <span class="n">Shuffle</span>
<span class="kn">from</span> <span class="nn">nvtabular.utils</span> <span class="kn">import</span> <span class="n">device_mem_size</span>
<span class="kn">from</span> <span class="nn">nvtabular.ops</span> <span class="kn">import</span> <span class="n">Categorify</span><span class="p">,</span> <span class="n">Clip</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span> <span class="n">LambdaOp</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">,</span> <span class="n">Rename</span><span class="p">,</span> <span class="n">Operator</span><span class="p">,</span> <span class="n">get_embedding_sizes</span>
<span class="c1">#%load_ext memory_profiler</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;numba&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;asyncio&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

<span class="c1"># define dataset schema</span>
<span class="n">CATEGORICAL_COLUMNS</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">27</span><span class="p">)]</span>
<span class="n">CONTINUOUS_COLUMNS</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;I&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">)]</span>
<span class="n">LABEL_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
<span class="n">COLUMNS</span> <span class="o">=</span>  <span class="n">LABEL_COLUMNS</span> <span class="o">+</span> <span class="n">CONTINUOUS_COLUMNS</span> <span class="o">+</span>  <span class="n">CATEGORICAL_COLUMNS</span>
<span class="c1">#/samples/criteo mode doesn&#39;t have dense features</span>
<span class="n">criteo_COLUMN</span><span class="o">=</span><span class="n">LABEL_COLUMNS</span> <span class="o">+</span>  <span class="n">CATEGORICAL_COLUMNS</span>
<span class="c1">#For new feature cross columns</span>
<span class="n">CROSS_COLUMNS</span> <span class="o">=</span> <span class="p">[]</span>


<span class="n">NUM_INTEGER_COLUMNS</span> <span class="o">=</span> <span class="mi">13</span>
<span class="n">NUM_CATEGORICAL_COLUMNS</span> <span class="o">=</span> <span class="mi">26</span>
<span class="n">NUM_TOTAL_COLUMNS</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">NUM_INTEGER_COLUMNS</span> <span class="o">+</span> <span class="n">NUM_CATEGORICAL_COLUMNS</span>


<span class="c1"># Initialize RMM pool on ALL workers</span>
<span class="k">def</span> <span class="nf">setup_rmm_pool</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">):</span>
    <span class="n">client</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rmm</span><span class="o">.</span><span class="n">reinitialize</span><span class="p">,</span> <span class="n">pool_allocator</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">initial_pool_size</span><span class="o">=</span><span class="n">pool_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="c1">#compute the partition size with GB</span>
<span class="k">def</span> <span class="nf">bytesto</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">bsize</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">bsize</span> <span class="o">**</span> <span class="n">a</span><span class="p">[</span><span class="n">to</span><span class="p">])</span>

<span class="c1">#process the data with NVTabular</span>
<span class="k">def</span> <span class="nf">process_NVT</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">feature_cross_list</span><span class="p">:</span>
        <span class="n">feature_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">feature_cross_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">feature_pairs</span><span class="p">:</span>
            <span class="n">CROSS_COLUMNS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;NVTabular processing&#39;</span><span class="p">)</span>
    <span class="n">train_input</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;train/train.txt&quot;</span><span class="p">)</span>
    <span class="n">val_input</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;val/test.txt&quot;</span><span class="p">)</span>
    <span class="n">PREPROCESS_DIR_temp_train</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">out_path</span><span class="p">,</span> <span class="s1">&#39;train/temp-parquet-after-conversion&#39;</span><span class="p">)</span>
    <span class="n">PREPROCESS_DIR_temp_val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">out_path</span><span class="p">,</span> <span class="s1">&#39;val/temp-parquet-after-conversion&#39;</span><span class="p">)</span>
    <span class="n">PREPROCESS_DIR_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">PREPROCESS_DIR_temp_train</span><span class="p">,</span> <span class="n">PREPROCESS_DIR_temp_val</span><span class="p">]</span>
    <span class="n">train_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span>
    <span class="n">val_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)</span>

    <span class="c1"># Make sure we have a clean parquet space for cudf conversion</span>
    <span class="k">for</span> <span class="n">one_path</span> <span class="ow">in</span> <span class="n">PREPROCESS_DIR_temp</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">one_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">one_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">one_path</span><span class="p">)</span>


    <span class="c1">## Get Dask Client</span>

    <span class="c1"># Deploy a Single-Machine Multi-GPU Cluster</span>
    <span class="n">device_size</span> <span class="o">=</span> <span class="n">device_mem_size</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;total&quot;</span><span class="p">)</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="s2">&quot;ucx&quot;</span><span class="p">:</span>
        <span class="n">UCX_TLS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;UCX_TLS&quot;</span><span class="p">,</span> <span class="s2">&quot;tcp,cuda_copy,cuda_ipc,sockcm&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;UCX_TLS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UCX_TLS</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCUDACluster</span><span class="p">(</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">CUDA_VISIBLE_DEVICES</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span>
            <span class="n">n_workers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)),</span>
            <span class="n">enable_nvlink</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">device_memory_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">device_size</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">device_limit_frac</span><span class="p">),</span>
            <span class="n">dashboard_address</span><span class="o">=</span><span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">dashboard_port</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCUDACluster</span><span class="p">(</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">n_workers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)),</span>
            <span class="n">CUDA_VISIBLE_DEVICES</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span>
            <span class="n">device_memory_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">device_size</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">device_limit_frac</span><span class="p">),</span>
            <span class="n">dashboard_address</span><span class="o">=</span><span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">dashboard_port</span>
        <span class="p">)</span>



    <span class="c1"># Create the distributed client</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">device_pool_frac</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="n">setup_rmm_pool</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device_pool_frac</span><span class="o">*</span><span class="n">device_size</span><span class="p">))</span>


    <span class="c1">#calculate the total processing time</span>
    <span class="n">runtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1">#test dataset without the label feature</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_type</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">LABEL_COLUMNS</span>
        <span class="n">LABEL_COLUMNS</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">##-----------------------------------##</span>
    <span class="c1"># Dask rapids converts txt to parquet</span>
    <span class="c1"># Dask cudf dataframe = ddf</span>

    <span class="c1">## train/valid txt to parquet</span>
    <span class="n">train_valid_paths</span> <span class="o">=</span> <span class="p">[(</span><span class="n">train_input</span><span class="p">,</span><span class="n">PREPROCESS_DIR_temp_train</span><span class="p">),(</span><span class="n">val_input</span><span class="p">,</span><span class="n">PREPROCESS_DIR_temp_val</span><span class="p">)]</span>

    <span class="k">for</span> <span class="nb">input</span><span class="p">,</span> <span class="n">temp_output</span> <span class="ow">in</span> <span class="n">train_valid_paths</span><span class="p">:</span>

        <span class="n">ddf</span> <span class="o">=</span> <span class="n">dask_cudf</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">LABEL_COLUMNS</span> <span class="o">+</span> <span class="n">CONTINUOUS_COLUMNS</span> <span class="o">+</span> <span class="n">CATEGORICAL_COLUMNS</span><span class="p">)</span>

        <span class="c1">## Convert label col to FP32</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">parquet_format</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_type</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="n">ddf</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddf</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

        <span class="c1"># Save it as parquet format for better memory usage</span>
        <span class="n">ddf</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">temp_output</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">##-----------------------------------##</span>

    <span class="n">COLUMNS</span> <span class="o">=</span>  <span class="n">LABEL_COLUMNS</span> <span class="o">+</span> <span class="n">CONTINUOUS_COLUMNS</span> <span class="o">+</span> <span class="n">CROSS_COLUMNS</span> <span class="o">+</span> <span class="n">CATEGORICAL_COLUMNS</span>
    <span class="n">train_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PREPROCESS_DIR_temp_train</span><span class="p">,</span> <span class="s2">&quot;*.parquet&quot;</span><span class="p">))</span>
    <span class="n">valid_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PREPROCESS_DIR_temp_val</span><span class="p">,</span> <span class="s2">&quot;*.parquet&quot;</span><span class="p">))</span>

    <span class="n">categorify_op</span> <span class="o">=</span> <span class="n">Categorify</span><span class="p">(</span><span class="n">freq_threshold</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">freq_limit</span><span class="p">)</span>
    <span class="n">cat_features</span> <span class="o">=</span> <span class="n">CATEGORICAL_COLUMNS</span> <span class="o">&gt;&gt;</span> <span class="n">categorify_op</span>
    <span class="n">cont_features</span> <span class="o">=</span> <span class="n">CONTINUOUS_COLUMNS</span> <span class="o">&gt;&gt;</span> <span class="n">FillMissing</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="n">Clip</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">Normalize</span><span class="p">()</span>
    <span class="n">cross_cat_op</span> <span class="o">=</span> <span class="n">Categorify</span><span class="p">(</span><span class="n">encode_type</span><span class="o">=</span><span class="s2">&quot;combo&quot;</span><span class="p">,</span> <span class="n">freq_threshold</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">freq_limit</span><span class="p">)</span>

    <span class="n">features</span> <span class="o">=</span> <span class="n">LABEL_COLUMNS</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">criteo_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">+=</span> <span class="n">cont_features</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">feature_cross_list</span><span class="p">:</span>
            <span class="n">feature_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">feature_cross_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">feature_pairs</span><span class="p">:</span>
                <span class="n">features</span> <span class="o">+=</span> <span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">cross_cat_op</span>
    <span class="n">features</span> <span class="o">+=</span> <span class="n">cat_features</span>

    <span class="n">workflow</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preprocessing&quot;</span><span class="p">)</span>

    <span class="n">output_format</span> <span class="o">=</span> <span class="s1">&#39;hugectr&#39;</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">parquet_format</span><span class="p">:</span>
        <span class="n">output_format</span> <span class="o">=</span> <span class="s1">&#39;parquet&#39;</span>

    <span class="c1"># just for /samples/criteo model</span>
    <span class="n">train_ds_iterator</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">train_paths</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span> <span class="n">part_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">part_mem_frac</span> <span class="o">*</span> <span class="n">device_size</span><span class="p">))</span>
    <span class="n">valid_ds_iterator</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">valid_paths</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span> <span class="n">part_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">part_mem_frac</span> <span class="o">*</span> <span class="n">device_size</span><span class="p">))</span>

    <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">==</span> <span class="s2">&quot;PER_WORKER&quot;</span><span class="p">:</span>
        <span class="n">shuffle</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Shuffle</span><span class="o">.</span><span class="n">PER_WORKER</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">==</span> <span class="s2">&quot;PER_PARTITION&quot;</span><span class="p">:</span>
        <span class="n">shuffle</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Shuffle</span><span class="o">.</span><span class="n">PER_PARTITION</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Train Datasets Preprocessing.....&#39;</span><span class="p">)</span>

    <span class="n">dict_dtypes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">CATEGORICAL_COLUMNS</span><span class="p">:</span>
        <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">criteo_mode</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">CONTINUOUS_COLUMNS</span><span class="p">:</span>
            <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">CROSS_COLUMNS</span><span class="p">:</span>
        <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">LABEL_COLUMNS</span><span class="p">:</span>
        <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    
    <span class="n">conts</span> <span class="o">=</span> <span class="n">CONTINUOUS_COLUMNS</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">criteo_mode</span> <span class="k">else</span> <span class="p">[]</span>
    
    <span class="n">workflow</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ds_iterator</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s1">&#39;hugectr&#39;</span><span class="p">:</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_ds_iterator</span><span class="p">)</span><span class="o">.</span><span class="n">to_hugectr</span><span class="p">(</span>
                <span class="n">cats</span><span class="o">=</span><span class="n">CATEGORICAL_COLUMNS</span> <span class="o">+</span> <span class="n">CROSS_COLUMNS</span><span class="p">,</span>
                <span class="n">conts</span><span class="o">=</span><span class="n">conts</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">LABEL_COLUMNS</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">train_output</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
                <span class="n">out_files_per_proc</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">out_files_per_proc</span><span class="p">,</span>
                <span class="n">num_threads</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_io_threads</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_ds_iterator</span><span class="p">)</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">train_output</span><span class="p">,</span>
                <span class="n">dtypes</span><span class="o">=</span><span class="n">dict_dtypes</span><span class="p">,</span>
                <span class="n">cats</span><span class="o">=</span><span class="n">CATEGORICAL_COLUMNS</span> <span class="o">+</span> <span class="n">CROSS_COLUMNS</span><span class="p">,</span>
                <span class="n">conts</span><span class="o">=</span><span class="n">conts</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">LABEL_COLUMNS</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
                <span class="n">out_files_per_proc</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">out_files_per_proc</span><span class="p">,</span>
                <span class="n">num_threads</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_io_threads</span><span class="p">)</span>
        
        
        
    <span class="c1">###Getting slot size###    </span>
    <span class="c1">#--------------------##</span>
    <span class="n">embeddings_dict_cat</span> <span class="o">=</span> <span class="n">categorify_op</span><span class="o">.</span><span class="n">get_embedding_sizes</span><span class="p">(</span><span class="n">CATEGORICAL_COLUMNS</span><span class="p">)</span>
    <span class="n">embeddings_dict_cross</span> <span class="o">=</span> <span class="n">cross_cat_op</span><span class="o">.</span><span class="n">get_embedding_sizes</span><span class="p">(</span><span class="n">CROSS_COLUMNS</span><span class="p">)</span>
    <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[</span><span class="n">embeddings_dict_cat</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CATEGORICAL_COLUMNS</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">embeddings_dict_cross</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROSS_COLUMNS</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
    <span class="c1">##--------------------##</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Valid Datasets Preprocessing.....&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s1">&#39;hugectr&#39;</span><span class="p">:</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">valid_ds_iterator</span><span class="p">)</span><span class="o">.</span><span class="n">to_hugectr</span><span class="p">(</span>
                <span class="n">cats</span><span class="o">=</span><span class="n">CATEGORICAL_COLUMNS</span> <span class="o">+</span> <span class="n">CROSS_COLUMNS</span><span class="p">,</span>
                <span class="n">conts</span><span class="o">=</span><span class="n">conts</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">LABEL_COLUMNS</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">val_output</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
                <span class="n">out_files_per_proc</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">out_files_per_proc</span><span class="p">,</span>
                <span class="n">num_threads</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_io_threads</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">valid_ds_iterator</span><span class="p">)</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">val_output</span><span class="p">,</span>
                <span class="n">dtypes</span><span class="o">=</span><span class="n">dict_dtypes</span><span class="p">,</span>
                <span class="n">cats</span><span class="o">=</span><span class="n">CATEGORICAL_COLUMNS</span> <span class="o">+</span> <span class="n">CROSS_COLUMNS</span><span class="p">,</span>
                <span class="n">conts</span><span class="o">=</span><span class="n">conts</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">LABEL_COLUMNS</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
                <span class="n">out_files_per_proc</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">out_files_per_proc</span><span class="p">,</span>
                <span class="n">num_threads</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_io_threads</span><span class="p">)</span>

    <span class="n">embeddings_dict_cat</span> <span class="o">=</span> <span class="n">categorify_op</span><span class="o">.</span><span class="n">get_embedding_sizes</span><span class="p">(</span><span class="n">CATEGORICAL_COLUMNS</span><span class="p">)</span>
    <span class="n">embeddings_dict_cross</span> <span class="o">=</span> <span class="n">cross_cat_op</span><span class="o">.</span><span class="n">get_embedding_sizes</span><span class="p">(</span><span class="n">CROSS_COLUMNS</span><span class="p">)</span>
    <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[</span><span class="n">embeddings_dict_cat</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CATEGORICAL_COLUMNS</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">embeddings_dict_cross</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROSS_COLUMNS</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
    <span class="c1">##--------------------##</span>

    <span class="c1">## Shutdown clusters</span>
    <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;NVTabular processing done&#39;</span><span class="p">)</span>

    <span class="n">runtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">runtime</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Dask-NVTabular Criteo Preprocessing&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data_path          | </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">data_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output_path        | </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;partition size     | </span><span class="si">{</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1"> GB&#39;</span><span class="o">%</span><span class="n">bytesto</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">part_mem_frac</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">device_size</span><span class="p">),</span><span class="s1">&#39;g&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;protocol           | </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;device(s)          | </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">devices</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rmm-pool-frac      | </span><span class="si">{</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device_pool_frac</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out-files-per-proc | </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">out_files_per_proc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;num_io_threads     | </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">num_io_threads</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;shuffle            | </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">shuffle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======================================&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime[s]         | </span><span class="si">{</span><span class="n">runtime</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======================================</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Multi-GPU Criteo Preprocessing&quot;</span><span class="p">))</span>

    <span class="c1">#</span>
    <span class="c1"># System Options</span>
    <span class="c1">#</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Input dataset path (Required)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--out_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory path to write output (Required)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--devices&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Comma-separated list of visible devices (e.g. &quot;0,1,2,3&quot;). &#39;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--protocol&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tcp&quot;</span><span class="p">,</span> <span class="s2">&quot;ucx&quot;</span><span class="p">],</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;tcp&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Communication protocol to use (Default &#39;tcp&#39;)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--device_limit_frac&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Worker device-memory limit as a fraction of GPU capacity (Default 0.8). &quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--device_pool_frac&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;RMM pool size for each worker  as a fraction of GPU capacity (Default 0.9). &quot;</span>
        <span class="s2">&quot;The RMM pool frac is the same for all GPUs, make sure each one has enough memory size&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--num_io_threads&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of threads to use when writing output data (Default 0). &quot;</span>
        <span class="s2">&quot;If 0 is specified, multi-threading will not be used for IO.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Data-Decomposition Parameters</span>
    <span class="c1">#</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--part_mem_frac&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.125</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum size desired for dataset partitions as a fraction &quot;</span>
        <span class="s2">&quot;of GPU capacity (Default 0.125)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--out_files_per_proc&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of output files to write on each worker (Default 1)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Preprocessing Options</span>
    <span class="c1">#</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--freq_limit&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Frequency limit for categorical encoding (Default 0)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--shuffle&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PER_WORKER&quot;</span><span class="p">,</span> <span class="s2">&quot;PER_PARTITION&quot;</span><span class="p">,</span> <span class="s2">&quot;NONE&quot;</span><span class="p">],</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;PER_PARTITION&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Shuffle algorithm to use when writing output data to disk (Default PER_PARTITION)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--feature_cross_list&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;List of feature crossing cols (e.g. C1_C2, C3_C4)&quot;</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Diagnostics Options</span>
    <span class="c1">#</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--profile&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify a file path to export a Dask profile report (E.g. dask-report.html).&quot;</span>
        <span class="s2">&quot;If this option is excluded from the command, not profile will be exported&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--dashboard_port&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;8787&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify the desired port of Dask&#39;s diagnostics-dashboard (Default `3787`). &quot;</span>
        <span class="s2">&quot;The dashboard will be hosted at http://&lt;IP&gt;:&lt;PORT&gt;/status&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Format</span>
    <span class="c1">#</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--criteo_mode&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--parquet_format&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dataset_type&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">args</span><span class="o">.</span><span class="n">n_workers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">args</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>

    <span class="n">process_NVT</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing /wdl_train/preprocess.py
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!python3 /wdl_train/preprocess.py --data_path /wdl_train/ \
--out_path /wdl_train/ --freq_limit 6 --feature_cross_list C1_C2,C3_C4 \
--device_pool_frac 0.5  --devices &#39;0&#39; --num_io_threads 2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-02-10 10:32:34,808 NVTabular processing
2023-02-10 10:32:36,590 - distributed.preloading - INFO - Creating preload: dask_cuda.initialize
2023-02-10 10:32:36,590 - distributed.preloading - INFO - Import preload module: dask_cuda.initialize
2023-02-10 10:32:36,604 Unable to start CUDA Context
Traceback (most recent call last):
  File &quot;/usr/local/lib/python3.8/dist-packages/pynvml/nvml.py&quot;, line 782, in _nvmlGetFunctionPointer
    _nvmlGetFunctionPointer_cache[name] = getattr(nvmlLib, name)
  File &quot;/usr/lib/python3.8/ctypes/__init__.py&quot;, line 386, in __getattr__
    func = self.__getitem__(name)
  File &quot;/usr/lib/python3.8/ctypes/__init__.py&quot;, line 391, in __getitem__
    func = self._FuncPtr((name_or_ordinal, self))
AttributeError: /usr/lib/x86_64-linux-gnu/libnvidia-ml.so.1: undefined symbol: nvmlDeviceGetComputeRunningProcesses_v2

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File &quot;/usr/local/lib/python3.8/dist-packages/dask_cuda/initialize.py&quot;, line 41, in _create_cuda_context
    ctx = has_cuda_context()
  File &quot;/usr/local/lib/python3.8/dist-packages/distributed/diagnostics/nvml.py&quot;, line 164, in has_cuda_context
    running_processes = pynvml.nvmlDeviceGetComputeRunningProcesses_v2(handle)
  File &quot;/usr/local/lib/python3.8/dist-packages/pynvml/nvml.py&quot;, line 2191, in nvmlDeviceGetComputeRunningProcesses_v2
    fn = _nvmlGetFunctionPointer(&quot;nvmlDeviceGetComputeRunningProcesses_v2&quot;)
  File &quot;/usr/local/lib/python3.8/dist-packages/pynvml/nvml.py&quot;, line 785, in _nvmlGetFunctionPointer
    raise NVMLError(NVML_ERROR_FUNCTION_NOT_FOUND)
pynvml.nvml.NVMLError_FunctionNotFound: Function Not Found
/usr/local/lib/python3.8/dist-packages/merlin/core/utils.py:384: FutureWarning: The `client` argument is deprecated from DaskExecutor and will be removed in a future version of NVTabular. By default, a global client in the same python context will be detected automatically, and `merlin.utils.set_dask_client` (as well as `Distributed` and `Serial`) can be used for explicit control.
  warnings.warn(
2023-02-10 10:32:54,260 Preprocessing
2023-02-10 10:32:54,521 Train Datasets Preprocessing.....
[249058, 19561, 14212, 6890, 18592, 4, 6356, 1254, 52, 226170, 80508, 72308, 11, 2169, 7597, 61, 4, 923, 15, 249619, 168974, 243480, 68212, 9169, 75, 34, 281564, 415262]
2023-02-10 10:34:09,155 Valid Datasets Preprocessing.....
[249058, 19561, 14212, 6890, 18592, 4, 6356, 1254, 52, 226170, 80508, 72308, 11, 2169, 7597, 61, 4, 923, 15, 249619, 168974, 243480, 68212, 9169, 75, 34, 281564, 415262]
2023-02-10 10:34:10,596 NVTabular processing done

Dask-NVTabular Criteo Preprocessing
--------------------------------------
data_path          | /wdl_train/
output_path        | /wdl_train/
partition size     | 3.97 GB
protocol           | tcp
device(s)          | 0
rmm-pool-frac      | 0.5
out-files-per-proc | 1
num_io_threads     | 2
shuffle            | PER_PARTITION
======================================
Runtime[s]         | 92.90126419067383
======================================
</pre></div>
</div>
</div>
</div>
<div class="section" id="check-the-preprocessed-training-data">
<h4>Check the preprocessed training data<a class="headerlink" href="#check-the-preprocessed-training-data" title="Permalink to this headline"></a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>ls<span class="w"> </span>-ll<span class="w"> </span>/wdl_train/train
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>total 14449264
-rw-r--r-- 1 root root          34 Feb 10 10:34 _file_list.txt
-rw-r--r-- 1 root root      450893 Feb 10 10:34 _metadata
-rw-r--r-- 1 root root        1510 Feb 10 10:34 _metadata.json
-rw-r--r-- 1 root root  3245838178 Feb 10 10:34 part_0.parquet
-rw-r--r-- 1 root root       27296 Feb 10 10:33 schema.pbtxt
drwxr-xr-x 2 root root        4096 Feb 10 10:32 temp-parquet-after-conversion
-rw-r--r-- 1 root root 11549710546 Feb 10 10:32 train.txt
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="wdl-model-training">
<h3>WDL Model Training<a class="headerlink" href="#wdl-model-training" title="Permalink to this headline"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> &#39;./model.py&#39;
<span class="kn">import</span> <span class="nn">hugectr</span>
<span class="c1">#from mpi4py import MPI</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">CreateSolver</span><span class="p">(</span><span class="n">max_eval_batches</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span>
                              <span class="n">batchsize_eval</span> <span class="o">=</span> <span class="mi">2720</span><span class="p">,</span>
                              <span class="n">batchsize</span> <span class="o">=</span> <span class="mi">2720</span><span class="p">,</span>
                              <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
                              <span class="n">vvgpu</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">2</span><span class="p">]],</span>
                              <span class="n">repeat_dataset</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                              <span class="n">i64_input_key</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">reader</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">DataReaderParams</span><span class="p">(</span><span class="n">data_reader_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">DataReaderType_t</span><span class="o">.</span><span class="n">Parquet</span><span class="p">,</span>
                                  <span class="n">source</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/wdl_train/train/_file_list.txt&quot;</span><span class="p">],</span>
                                  <span class="n">eval_source</span> <span class="o">=</span> <span class="s2">&quot;/wdl_train/val/_file_list.txt&quot;</span><span class="p">,</span>
                                  <span class="n">check_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Check_t</span><span class="o">.</span><span class="n">Non</span><span class="p">,</span>
                                  <span class="n">slot_size_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">249058</span><span class="p">,</span> <span class="mi">19561</span><span class="p">,</span> <span class="mi">14212</span><span class="p">,</span> <span class="mi">6890</span><span class="p">,</span> <span class="mi">18592</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6356</span><span class="p">,</span> <span class="mi">1254</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">226170</span><span class="p">,</span> <span class="mi">80508</span><span class="p">,</span> <span class="mi">72308</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2169</span><span class="p">,</span> <span class="mi">7597</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">923</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">249619</span><span class="p">,</span> <span class="mi">168974</span><span class="p">,</span> <span class="mi">243480</span><span class="p">,</span> <span class="mi">68212</span><span class="p">,</span> <span class="mi">9169</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">278018</span><span class="p">,</span> <span class="mi">415262</span><span class="p">])</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">CreateOptimizer</span><span class="p">(</span><span class="n">optimizer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Optimizer_t</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span>
                                    <span class="n">update_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Update_t</span><span class="o">.</span><span class="n">Global</span><span class="p">,</span>
                                    <span class="n">beta1</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
                                    <span class="n">beta2</span> <span class="o">=</span> <span class="mf">0.999</span><span class="p">,</span>
                                    <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.0000001</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">label_dim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">label_name</span> <span class="o">=</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span>
                        <span class="n">dense_dim</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span> <span class="n">dense_name</span> <span class="o">=</span> <span class="s2">&quot;dense&quot;</span><span class="p">,</span>
                        <span class="n">data_reader_sparse_param_array</span> <span class="o">=</span> 
                        <span class="p">[</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DataReaderSparseParam</span><span class="p">(</span><span class="s2">&quot;wide_data&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="n">hugectr</span><span class="o">.</span><span class="n">DataReaderSparseParam</span><span class="p">(</span><span class="s2">&quot;deep_data&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">26</span><span class="p">)]))</span>

<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">SparseEmbedding</span><span class="p">(</span><span class="n">embedding_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Embedding_t</span><span class="o">.</span><span class="n">DistributedSlotSparseEmbeddingHash</span><span class="p">,</span> 
                            <span class="n">workspace_size_per_gpu_in_mb</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
                            <span class="n">embedding_vec_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">combiner</span> <span class="o">=</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                            <span class="n">sparse_embedding_name</span> <span class="o">=</span> <span class="s2">&quot;sparse_embedding2&quot;</span><span class="p">,</span>
                            <span class="n">bottom_name</span> <span class="o">=</span> <span class="s2">&quot;wide_data&quot;</span><span class="p">,</span>
                            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">SparseEmbedding</span><span class="p">(</span><span class="n">embedding_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Embedding_t</span><span class="o">.</span><span class="n">DistributedSlotSparseEmbeddingHash</span><span class="p">,</span> 
                            <span class="n">workspace_size_per_gpu_in_mb</span> <span class="o">=</span> <span class="mi">405</span><span class="p">,</span>
                            <span class="n">embedding_vec_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
                            <span class="n">combiner</span> <span class="o">=</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                            <span class="n">sparse_embedding_name</span> <span class="o">=</span> <span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">,</span>
                            <span class="n">bottom_name</span> <span class="o">=</span> <span class="s2">&quot;deep_data&quot;</span><span class="p">,</span>
                            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">Reshape</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;reshape1&quot;</span><span class="p">],</span>
                            <span class="n">leading_dim</span><span class="o">=</span><span class="mi">416</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">Reshape</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sparse_embedding2&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;reshape2&quot;</span><span class="p">],</span>
                            <span class="n">leading_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">ReduceSum</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;reshape2&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;wide_redn&quot;</span><span class="p">],</span>
                            <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">Concat</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;reshape1&quot;</span><span class="p">,</span> <span class="s2">&quot;dense&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;concat1&quot;</span><span class="p">]))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">InnerProduct</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;concat1&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fc1&quot;</span><span class="p">],</span>
                            <span class="n">num_output</span><span class="o">=</span><span class="mi">1024</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">ReLU</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fc1&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;relu1&quot;</span><span class="p">]))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">Dropout</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;relu1&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dropout1&quot;</span><span class="p">],</span>
                            <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">InnerProduct</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dropout1&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fc2&quot;</span><span class="p">],</span>
                            <span class="n">num_output</span><span class="o">=</span><span class="mi">1024</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">ReLU</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fc2&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;relu2&quot;</span><span class="p">]))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">Dropout</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;relu2&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dropout2&quot;</span><span class="p">],</span>
                            <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">InnerProduct</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dropout2&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fc3&quot;</span><span class="p">],</span>
                            <span class="n">num_output</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">Add</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fc3&quot;</span><span class="p">,</span> <span class="s2">&quot;wide_redn&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;add1&quot;</span><span class="p">]))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hugectr</span><span class="o">.</span><span class="n">DenseLayer</span><span class="p">(</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">Layer_t</span><span class="o">.</span><span class="n">BinaryCrossEntropyLoss</span><span class="p">,</span>
                            <span class="n">bottom_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;add1&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">],</span>
                            <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]))</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">max_iter</span> <span class="o">=</span> <span class="mi">21000</span><span class="p">,</span> <span class="n">display</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">eval_interval</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span> <span class="n">snapshot</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">,</span> <span class="n">snapshot_prefix</span> <span class="o">=</span> <span class="s2">&quot;wdl&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">graph_to_json</span><span class="p">(</span><span class="n">graph_config_file</span> <span class="o">=</span> <span class="s2">&quot;wdl.json&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Overwriting ./model.py
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>./model.py
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HugeCTR Version: 4.2
====================================================Model Init=====================================================
[HCTR][10:35:38.637][WARNING][RK0][main]: The model name is not specified when creating the solver.
[HCTR][10:35:38.637][INFO][RK0][main]: Global seed is 1886280762
[HCTR][10:35:38.640][INFO][RK0][main]: Device to NUMA mapping:
  GPU 2 -&gt;  node 0
[HCTR][10:35:40.821][WARNING][RK0][main]: Peer-to-peer access cannot be fully enabled.
[HCTR][10:35:40.821][DEBUG][RK0][main]: [device 2] allocating 0.0000 GB, available 30.8035 
[HCTR][10:35:40.821][INFO][RK0][main]: Start all2all warmup
[HCTR][10:35:40.821][INFO][RK0][main]: End all2all warmup
[HCTR][10:35:40.822][INFO][RK0][main]: Using All-reduce algorithm: NCCL
[HCTR][10:35:40.823][INFO][RK0][main]: Device 2: Tesla V100-SXM2-32GB
[HCTR][10:35:40.824][INFO][RK0][main]: num of DataReader workers for train: 1
[HCTR][10:35:40.824][INFO][RK0][main]: num of DataReader workers for eval: 1
[HCTR][10:35:40.824][DEBUG][RK0][main]: [device 2] allocating 0.0054 GB, available 30.5476 
[HCTR][10:35:40.825][DEBUG][RK0][main]: [device 2] allocating 0.0054 GB, available 30.5417 
[HCTR][10:35:40.825][DEBUG][RK0][main]: [device 2] allocating 0.0000 GB, available 30.5417 
[HCTR][10:35:40.826][DEBUG][RK0][main]: [device 2] allocating 0.0000 GB, available 30.5417 
[HCTR][10:35:40.826][INFO][RK0][main]: Vocabulary size: 2138588
[HCTR][10:35:40.826][INFO][RK0][main]: max_vocabulary_size_per_gpu_=2097152
[HCTR][10:35:40.838][DEBUG][RK0][main]: [device 2] allocating 0.0241 GB, available 30.3914 
[HCTR][10:35:40.845][INFO][RK0][main]: max_vocabulary_size_per_gpu_=2211840
[HCTR][10:35:40.851][DEBUG][RK0][main]: [device 2] allocating 0.4288 GB, available 29.9617 
[HCTR][10:35:40.851][INFO][RK0][main]: Graph analysis to resolve tensor dependency
===================================================Model Compile===================================================
[HCTR][10:35:40.856][DEBUG][RK0][main]: [device 2] allocating 0.2162 GB, available 29.4792 
[HCTR][10:35:40.856][DEBUG][RK0][main]: [device 2] allocating 0.0056 GB, available 29.4734 
[HCTR][10:35:50.016][INFO][RK0][main]: gpu0 start to init embedding
[HCTR][10:35:50.016][INFO][RK0][main]: gpu0 init embedding done
[HCTR][10:35:50.016][INFO][RK0][main]: gpu0 start to init embedding
[HCTR][10:35:50.017][INFO][RK0][main]: gpu0 init embedding done
[HCTR][10:35:50.017][DEBUG][RK0][main]: [device 2] allocating 0.0001 GB, available 29.4734 
[HCTR][10:35:50.019][INFO][RK0][main]: Starting AUC NCCL warm-up
[HCTR][10:35:50.023][INFO][RK0][main]: Warm-up done
===================================================Model Summary===================================================
[HCTR][10:35:50.023][INFO][RK0][main]: Model structure on each GPU
Label                                   Dense                         Sparse                        
label                                   dense                          wide_data,deep_data           
(2720,1)                                (2720,13)                               
——————————————————————————————————————————————————————————————————————————————————————————————————————————————————
Layer Type                              Input Name                    Output Name                   Output Shape                  
——————————————————————————————————————————————————————————————————————————————————————————————————————————————————
DistributedSlotSparseEmbeddingHash      wide_data                     sparse_embedding2             (2720,2,1)                    
------------------------------------------------------------------------------------------------------------------
DistributedSlotSparseEmbeddingHash      deep_data                     sparse_embedding1             (2720,26,16)                  
------------------------------------------------------------------------------------------------------------------
Reshape                                 sparse_embedding1             reshape1                      (2720,416)                    
------------------------------------------------------------------------------------------------------------------
Reshape                                 sparse_embedding2             reshape2                      (2720,2)                      
------------------------------------------------------------------------------------------------------------------
ReduceSum                               reshape2                      wide_redn                     (2720,1)                      
------------------------------------------------------------------------------------------------------------------
Concat                                  reshape1                      concat1                       (2720,429)                    
                                        dense                                                                                     
------------------------------------------------------------------------------------------------------------------
InnerProduct                            concat1                       fc1                           (2720,1024)                   
------------------------------------------------------------------------------------------------------------------
ReLU                                    fc1                           relu1                         (2720,1024)                   
------------------------------------------------------------------------------------------------------------------
Dropout                                 relu1                         dropout1                      (2720,1024)                   
------------------------------------------------------------------------------------------------------------------
InnerProduct                            dropout1                      fc2                           (2720,1024)                   
------------------------------------------------------------------------------------------------------------------
ReLU                                    fc2                           relu2                         (2720,1024)                   
------------------------------------------------------------------------------------------------------------------
Dropout                                 relu2                         dropout2                      (2720,1024)                   
------------------------------------------------------------------------------------------------------------------
InnerProduct                            dropout2                      fc3                           (2720,1)                      
------------------------------------------------------------------------------------------------------------------
Add                                     fc3                           add1                          (2720,1)                      
                                        wide_redn                                                                                 
------------------------------------------------------------------------------------------------------------------
BinaryCrossEntropyLoss                  add1                          loss                                                        
                                        label                                                                                     
------------------------------------------------------------------------------------------------------------------
=====================================================Model Fit=====================================================
[HCTR][10:35:50.024][INFO][RK0][main]: Use non-epoch mode with number of iterations: 21000
[HCTR][10:35:50.024][INFO][RK0][main]: Training batchsize: 2720, evaluation batchsize: 2720
[HCTR][10:35:50.024][INFO][RK0][main]: Evaluation interval: 4000, snapshot interval: 20000
[HCTR][10:35:50.024][INFO][RK0][main]: Dense network trainable: True
[HCTR][10:35:50.024][INFO][RK0][main]: Sparse embedding sparse_embedding1 trainable: True
[HCTR][10:35:50.024][INFO][RK0][main]: Sparse embedding sparse_embedding2 trainable: True
[HCTR][10:35:50.024][INFO][RK0][main]: Use mixed precision: False, scaler: 1.000000, use cuda graph: True
[HCTR][10:35:50.024][INFO][RK0][main]: lr: 0.001000, warmup_steps: 1, end_lr: 0.000000
[HCTR][10:35:50.024][INFO][RK0][main]: decay_start: 0, decay_steps: 1, decay_power: 2.000000
[HCTR][10:35:50.024][INFO][RK0][main]: Training source file: /wdl_train/train/_file_list.txt
[HCTR][10:35:50.024][INFO][RK0][main]: Evaluation source file: /wdl_train/val/_file_list.txt
[HCTR][10:35:55.354][INFO][RK0][main]: Iter: 1000 Time(1000 iters): 5.32919s Loss: 0.117964 lr:0.001
[HCTR][10:36:00.665][INFO][RK0][main]: Iter: 2000 Time(1000 iters): 5.30907s Loss: 0.126084 lr:0.001
[HCTR][10:36:06.002][INFO][RK0][main]: Iter: 3000 Time(1000 iters): 5.33581s Loss: 0.138335 lr:0.001
[HCTR][10:36:11.349][INFO][RK0][main]: Iter: 4000 Time(1000 iters): 5.34525s Loss: 0.101962 lr:0.001
[HCTR][10:36:15.933][INFO][RK0][main]: Evaluation, AUC: 0.763947
[HCTR][10:36:15.933][INFO][RK0][main]: Eval Time for 4000 iters: 4.583s
[HCTR][10:36:21.258][INFO][RK0][main]: Iter: 5000 Time(1000 iters): 9.90761s Loss: 0.120185 lr:0.001
[HCTR][10:36:26.620][INFO][RK0][main]: Iter: 6000 Time(1000 iters): 5.35972s Loss: 0.128626 lr:0.001
[HCTR][10:36:31.947][INFO][RK0][main]: Iter: 7000 Time(1000 iters): 5.32628s Loss: 0.125264 lr:0.001
[HCTR][10:36:37.320][INFO][RK0][main]: Iter: 8000 Time(1000 iters): 5.37131s Loss: 0.121486 lr:0.001
[HCTR][10:36:41.803][INFO][RK0][main]: Evaluation, AUC: 0.767916
[HCTR][10:36:41.803][INFO][RK0][main]: Eval Time for 4000 iters: 4.48175s
[HCTR][10:36:47.154][INFO][RK0][main]: Iter: 9000 Time(1000 iters): 9.83223s Loss: 0.109454 lr:0.001
[HCTR][10:36:52.522][INFO][RK0][main]: Iter: 10000 Time(1000 iters): 5.36677s Loss: 0.149472 lr:0.001
[HCTR][10:36:57.896][INFO][RK0][main]: Iter: 11000 Time(1000 iters): 5.37183s Loss: 0.118341 lr:0.001
[HCTR][10:37:03.264][INFO][RK0][main]: Iter: 12000 Time(1000 iters): 5.36706s Loss: 0.128496 lr:0.001
[HCTR][10:37:07.728][INFO][RK0][main]: Evaluation, AUC: 0.769081
[HCTR][10:37:07.728][INFO][RK0][main]: Eval Time for 4000 iters: 4.46314s
[HCTR][10:37:13.098][INFO][RK0][main]: Iter: 13000 Time(1000 iters): 9.83154s Loss: 0.118482 lr:0.001
[HCTR][10:37:18.447][INFO][RK0][main]: Iter: 14000 Time(1000 iters): 5.34802s Loss: 0.122699 lr:0.001
[HCTR][10:37:23.812][INFO][RK0][main]: Iter: 15000 Time(1000 iters): 5.36294s Loss: 0.118947 lr:0.001
[HCTR][10:37:29.176][INFO][RK0][main]: Iter: 16000 Time(1000 iters): 5.36303s Loss: 0.112516 lr:0.001
[HCTR][10:37:33.646][INFO][RK0][main]: Evaluation, AUC: 0.772322
[HCTR][10:37:33.646][INFO][RK0][main]: Eval Time for 4000 iters: 4.46896s
[HCTR][10:37:39.146][INFO][RK0][main]: Iter: 17000 Time(1000 iters): 9.96806s Loss: 0.11619 lr:0.001
[HCTR][10:37:44.517][INFO][RK0][main]: Iter: 18000 Time(1000 iters): 5.37011s Loss: 0.113035 lr:0.001
[HCTR][10:37:49.891][INFO][RK0][main]: Iter: 19000 Time(1000 iters): 5.37157s Loss: 0.116589 lr:0.001
[HCTR][10:37:55.236][INFO][RK0][main]: Iter: 20000 Time(1000 iters): 5.34424s Loss: 0.127488 lr:0.001
[HCTR][10:37:59.698][INFO][RK0][main]: Evaluation, AUC: 0.768523
[HCTR][10:37:59.698][INFO][RK0][main]: Eval Time for 4000 iters: 4.46044s
[HCTR][10:37:59.698][INFO][RK0][main]: Using Local file system backend.
[HCTR][10:37:59.771][INFO][RK0][main]: Rank0: Write hash table to file
[HCTR][10:37:59.810][INFO][RK0][main]: Using Local file system backend.
[HCTR][10:37:59.867][INFO][RK0][main]: Rank0: Write hash table to file
[HCTR][10:38:00.091][INFO][RK0][main]: Dumping sparse weights to files, successful
[HCTR][10:38:00.092][INFO][RK0][main]: Rank0: Write optimzer state to file
[HCTR][10:38:00.092][INFO][RK0][main]: Using Local file system backend.
[HCTR][10:38:00.115][INFO][RK0][main]: Done
[HCTR][10:38:00.116][INFO][RK0][main]: Rank0: Write optimzer state to file
[HCTR][10:38:00.116][INFO][RK0][main]: Using Local file system backend.
[HCTR][10:38:00.140][INFO][RK0][main]: Done
[HCTR][10:38:00.245][INFO][RK0][main]: Rank0: Write optimzer state to file
[HCTR][10:38:00.245][INFO][RK0][main]: Using Local file system backend.
[HCTR][10:38:00.610][INFO][RK0][main]: Done
[HCTR][10:38:00.695][INFO][RK0][main]: Rank0: Write optimzer state to file
[HCTR][10:38:00.695][INFO][RK0][main]: Using Local file system backend.
[HCTR][10:38:01.057][INFO][RK0][main]: Done
[HCTR][10:38:01.063][INFO][RK0][main]: Dumping sparse optimzer states to files, successful
[HCTR][10:38:01.064][INFO][RK0][main]: Using Local file system backend.
[HCTR][10:38:01.079][INFO][RK0][main]: Dumping dense weights to file, successful
[HCTR][10:38:01.081][INFO][RK0][main]: Using Local file system backend.
[HCTR][10:38:01.116][INFO][RK0][main]: Dumping dense optimizer states to file, successful
[HCTR][10:38:06.487][INFO][RK0][main]: Finish 21000 iterations with batchsize: 2720 in 136.46s.
[HCTR][10:38:06.488][INFO][RK0][main]: Save the model graph to wdl.json successfully
[1676025486.656545] [dgx1v-loki-23:602  :0] cuda_copy_iface.c:468  UCX  ERROR cuCtxGetCurrent(&amp;cuda_context)() failed: p�
[1676025486.656590] [dgx1v-loki-23:602  :0]  cuda_ipc_iface.c:531  UCX  ERROR cuCtxGetCurrent(&amp;cuda_context)() failed: 
[HCTR][10:38:06.707][INFO][RK0][main]: MPI finalization done.
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="prepare-inference-request">
<h2>Prepare Inference Request<a class="headerlink" href="#prepare-inference-request" title="Permalink to this headline"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>ls<span class="w"> </span>-l<span class="w"> </span>/wdl_train/val
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>total 633080
-rw-r--r-- 1 root root        32 Feb 10 10:34 _file_list.txt
-rw-r--r-- 1 root root     21894 Feb 10 10:34 _metadata
-rw-r--r-- 1 root root      1509 Feb 10 10:34 _metadata.json
-rw-r--r-- 1 root root 138441430 Feb 10 10:34 part_0.parquet
-rw-r--r-- 1 root root     27296 Feb 10 10:34 schema.pbtxt
drwxr-xr-x 2 root root        50 Feb 10 10:32 temp-parquet-after-conversion
-rw-r--r-- 1 root root 509766965 Feb 10 10:32 test.txt
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/wdl_train/val/part_0.parquet&quot;</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>I1</th>
      <th>I2</th>
      <th>I3</th>
      <th>I4</th>
      <th>I5</th>
      <th>I6</th>
      <th>I7</th>
      <th>I8</th>
      <th>I9</th>
      <th>I10</th>
      <th>...</th>
      <th>C17</th>
      <th>C18</th>
      <th>C19</th>
      <th>C20</th>
      <th>C21</th>
      <th>C22</th>
      <th>C23</th>
      <th>C24</th>
      <th>C25</th>
      <th>C26</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.054112</td>
      <td>-0.267624</td>
      <td>0.371471</td>
      <td>-0.076760</td>
      <td>-0.131771</td>
      <td>-0.206385</td>
      <td>-0.064249</td>
      <td>-0.208772</td>
      <td>0.324461</td>
      <td>-0.470383</td>
      <td>...</td>
      <td>1</td>
      <td>49</td>
      <td>1</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>9</td>
      <td>402</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.048792</td>
      <td>-0.547466</td>
      <td>-0.594327</td>
      <td>-0.157301</td>
      <td>-0.224758</td>
      <td>-0.206385</td>
      <td>-0.064249</td>
      <td>0.949396</td>
      <td>-0.760031</td>
      <td>-0.470383</td>
      <td>...</td>
      <td>3</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>1645</td>
      <td>0</td>
      <td>1358</td>
      <td>1232</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.059432</td>
      <td>-0.516221</td>
      <td>-0.594327</td>
      <td>-0.115539</td>
      <td>-0.209261</td>
      <td>-0.206385</td>
      <td>-0.064249</td>
      <td>-0.281810</td>
      <td>-0.687732</td>
      <td>-0.470383</td>
      <td>...</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>33190</td>
      <td>32473</td>
      <td>34242</td>
      <td>0</td>
      <td>954</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.029284</td>
      <td>-0.548824</td>
      <td>-0.057773</td>
      <td>-0.105099</td>
      <td>-0.224758</td>
      <td>-0.206385</td>
      <td>-0.064249</td>
      <td>-0.255725</td>
      <td>-0.760031</td>
      <td>-0.470383</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>622</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.061206</td>
      <td>-0.548824</td>
      <td>-0.594327</td>
      <td>-0.145369</td>
      <td>-0.209261</td>
      <td>-0.206385</td>
      <td>0.339399</td>
      <td>-0.281810</td>
      <td>0.035263</td>
      <td>-0.470383</td>
      <td>...</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>90</td>
      <td>143</td>
      <td>101</td>
      <td>0</td>
      <td>21</td>
      <td>1</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 42 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;/wdl_train/infer_test.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-prediction-scripts">
<h2>Create prediction scripts<a class="headerlink" href="#create-prediction-scripts" title="Permalink to this headline"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> &#39;/wdl_train/wdl_predict.py&#39;
<span class="kn">from</span> <span class="nn">hugectr.inference</span> <span class="kn">import</span> <span class="n">InferenceParams</span><span class="p">,</span> <span class="n">CreateInferenceSession</span>
<span class="kn">import</span> <span class="nn">hugectr</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="k">def</span> <span class="nf">wdl_inference</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">network_file</span><span class="p">,</span> <span class="n">dense_file</span><span class="p">,</span> <span class="n">embedding_file_list</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">enable_cache</span><span class="p">,</span> <span class="n">use_rocksdb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rocksdb_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">CATEGORICAL_COLUMNS</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">27</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="s2">&quot;C1_C2&quot;</span><span class="p">,</span><span class="s2">&quot;C3_C4&quot;</span><span class="p">]</span>
    <span class="n">CONTINUOUS_COLUMNS</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;I&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">)]</span>
    <span class="n">LABEL_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
    <span class="n">emb_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">249058</span><span class="p">,</span> <span class="mi">19561</span><span class="p">,</span> <span class="mi">14212</span><span class="p">,</span> <span class="mi">6890</span><span class="p">,</span> <span class="mi">18592</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6356</span><span class="p">,</span> <span class="mi">1254</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">226170</span><span class="p">,</span> <span class="mi">80508</span><span class="p">,</span> <span class="mi">72308</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2169</span><span class="p">,</span> <span class="mi">7597</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">923</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">249619</span><span class="p">,</span> <span class="mi">168974</span><span class="p">,</span> <span class="mi">243480</span><span class="p">,</span> <span class="mi">68212</span><span class="p">,</span> <span class="mi">9169</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">278018</span><span class="p">,</span> <span class="mi">415262</span><span class="p">]</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">emb_size</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">test_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">network_file</span>
    <span class="n">row_ptrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">21</span><span class="p">))</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">261</span><span class="p">))</span>
    <span class="n">dense_features</span> <span class="o">=</span>  <span class="nb">list</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">CONTINUOUS_COLUMNS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="n">test_df</span><span class="p">[</span><span class="n">CATEGORICAL_COLUMNS</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">embedding_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="n">test_df</span><span class="p">[</span><span class="n">CATEGORICAL_COLUMNS</span><span class="p">]</span><span class="o">+</span><span class="n">shift</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    
    
    <span class="n">persistent_db_params</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">PersistentDatabaseParams</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">use_rocksdb</span><span class="p">:</span>
        <span class="n">persistent_db_params</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">PersistentDatabaseParams</span><span class="p">(</span>
                                  <span class="n">backend</span> <span class="o">=</span> <span class="n">hugectr</span><span class="o">.</span><span class="n">DatabaseType_t</span><span class="o">.</span><span class="n">rocks_db</span><span class="p">,</span>
                                  <span class="n">path</span> <span class="o">=</span> <span class="n">rocksdb_path</span>
                                <span class="p">)</span>
    

    <span class="c1"># create parameter server, embedding cache and inference session</span>
    <span class="n">inference_params</span> <span class="o">=</span> <span class="n">InferenceParams</span><span class="p">(</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span><span class="p">,</span>
                                <span class="n">max_batchsize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
                                <span class="n">hit_rate_threshold</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                                <span class="n">dense_model_file</span> <span class="o">=</span> <span class="n">dense_file</span><span class="p">,</span>
                                <span class="n">sparse_model_files</span> <span class="o">=</span> <span class="n">embedding_file_list</span><span class="p">,</span>
                                <span class="n">device_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="n">use_gpu_embedding_cache</span> <span class="o">=</span> <span class="n">enable_cache</span><span class="p">,</span>
                                <span class="n">cache_size_percentage</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
                                <span class="n">persistent_db</span> <span class="o">=</span> <span class="n">persistent_db_params</span><span class="p">,</span>
                                <span class="n">i64_input_key</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">use_mixed_precision</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">inference_session</span> <span class="o">=</span> <span class="n">CreateInferenceSession</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">inference_params</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">inference_session</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dense_features</span><span class="p">,</span> <span class="n">embedding_columns</span><span class="p">,</span> <span class="n">row_ptrs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WDL multi-embedding table inference result is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> multi-embedding table prediction&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">))</span>
    <span class="n">network_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> multi-embedding table prediction network is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span><span class="n">network_file</span><span class="p">))</span>
    <span class="n">dense_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> multi-embedding table prediction dense file is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span><span class="n">dense_file</span><span class="p">))</span>
    <span class="n">embedding_file_list</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> multi-embedding table prediction sparse files are </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span><span class="n">embedding_file_list</span><span class="p">))</span>
    <span class="n">data_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> multi-embedding table prediction input data path is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span><span class="n">data_file</span><span class="p">))</span>
    <span class="n">input_dbtype</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> multi-embedding table prediction input dbtype path is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span><span class="n">input_dbtype</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">input_dbtype</span><span class="o">==</span><span class="s2">&quot;disabled&quot;</span><span class="p">:</span>
        <span class="n">wdl_inference</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">network_file</span><span class="p">,</span> <span class="n">dense_file</span><span class="p">,</span> <span class="n">embedding_file_list</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">input_dbtype</span><span class="o">==</span><span class="s2">&quot;rocksdb&quot;</span><span class="p">:</span>
        <span class="n">rocksdb_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> multi-embedding table prediction rocksdb_path path is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span><span class="n">rocksdb_path</span><span class="p">))</span>
        <span class="n">wdl_inference</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">network_file</span><span class="p">,</span> <span class="n">dense_file</span><span class="p">,</span> <span class="n">embedding_file_list</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">rocksdb_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Overwriting /wdl_train/wdl_predict.py
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="prediction">
<h2>Prediction<a class="headerlink" href="#prediction" title="Permalink to this headline"></a></h2>
<p>Use different types of databases as a local parameter server to get the wide and deep model prediction results.</p>
<div class="section" id="load-model-embedding-tables-into-local-memory-as-parameter-server">
<h3>Load model embedding tables into local memory as parameter server<a class="headerlink" href="#load-model-embedding-tables-into-local-memory-as-parameter-server" title="Permalink to this headline"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>/wdl_train/wdl_predict.py<span class="w"> </span><span class="s2">&quot;wdl&quot;</span><span class="w"> </span><span class="s2">&quot;./wdl.json&quot;</span><span class="w"> </span><span class="s2">&quot;./wdl_dense_20000.model&quot;</span><span class="w"> </span><span class="s2">&quot;./wdl0_sparse_20000.model/,./wdl1_sparse_20000.model&quot;</span><span class="w"> </span><span class="s2">&quot;/wdl_train/infer_test.csv&quot;</span><span class="w"> </span><span class="s2">&quot;disabled&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>wdl multi-embedding table prediction
wdl multi-embedding table prediction network is ./wdl.json
wdl multi-embedding table prediction dense file is ./wdl_dense_20000.model
wdl multi-embedding table prediction sparse files are [&#39;./wdl0_sparse_20000.model/&#39;, &#39;./wdl1_sparse_20000.model&#39;]
wdl multi-embedding table prediction input data path is /wdl_train/infer_test.csv
wdl multi-embedding table prediction input dbtype path is disabled
[HCTR][10:53:44.990][WARNING][RK0][main]: default_value_for_each_table.size() is not equal to the number of embedding tables
[HCTR][10:53:44.990][INFO][RK0][main]: default_emb_vec_value is not specified using default: 0
[HCTR][10:53:44.990][INFO][RK0][main]: default_emb_vec_value is not specified using default: 0
====================================================HPS Create====================================================
[HCTR][10:53:44.990][INFO][RK0][main]: Creating HashMap CPU database backend...
[HCTR][10:53:44.991][DEBUG][RK0][main]: Created blank database backend in local memory!
[HCTR][10:53:44.991][INFO][RK0][main]: Volatile DB: initial cache rate = 1
[HCTR][10:53:44.991][INFO][RK0][main]: Volatile DB: cache missed embeddings = 0
[HCTR][10:53:44.991][DEBUG][RK0][main]: Created raw model loader in local memory!
[HCTR][10:53:44.991][INFO][RK0][main]: Using Local file system backend.
[HCTR][10:53:45.479][INFO][RK0][main]: Table: hps_et.wdl.sparse_embedding2; cached 664320 / 664320 embeddings in volatile database (HashMapBackend); load: 664320 / 18446744073709551615 (0.00%).
[HCTR][10:53:45.479][INFO][RK0][main]: Using Local file system backend.
[HCTR][10:53:45.829][INFO][RK0][main]: Table: hps_et.wdl.sparse_embedding1; cached 1030499 / 1030499 embeddings in volatile database (HashMapBackend); load: 1030499 / 18446744073709551615 (0.00%).
[HCTR][10:53:45.836][DEBUG][RK0][main]: Real-time subscribers created!
[HCTR][10:53:45.836][INFO][RK0][main]: Creating embedding cache in device 0.
[HCTR][10:53:45.842][INFO][RK0][main]: Model name: wdl
[HCTR][10:53:45.842][INFO][RK0][main]: Max batch size: 64
[HCTR][10:53:45.842][INFO][RK0][main]: Number of embedding tables: 2
[HCTR][10:53:45.842][INFO][RK0][main]: Use GPU embedding cache: True, cache size percentage: 0.900000
[HCTR][10:53:45.842][INFO][RK0][main]: Use static table: False
[HCTR][10:53:45.842][INFO][RK0][main]: Use I64 input key: True
[HCTR][10:53:45.842][INFO][RK0][main]: Configured cache hit rate threshold: 0.500000
[HCTR][10:53:45.842][INFO][RK0][main]: The size of thread pool: 80
[HCTR][10:53:45.842][INFO][RK0][main]: The size of worker memory pool: 2
[HCTR][10:53:45.842][INFO][RK0][main]: The size of refresh memory pool: 1
[HCTR][10:53:45.842][INFO][RK0][main]: The refresh percentage : 0.000000
[HCTR][10:53:46.786][INFO][RK0][main]: Global seed is 1984285016
[HCTR][10:53:46.789][INFO][RK0][main]: Device to NUMA mapping:
  GPU 0 -&gt;  node 0
[HCTR][10:53:47.797][WARNING][RK0][main]: Peer-to-peer access cannot be fully enabled.
[HCTR][10:53:47.797][DEBUG][RK0][main]: [device 0] allocating 0.0000 GB, available 30.7156 
[HCTR][10:53:47.797][INFO][RK0][main]: Start all2all warmup
[HCTR][10:53:47.797][INFO][RK0][main]: End all2all warmup
[HCTR][10:53:47.798][INFO][RK0][main]: Model name: wdl
[HCTR][10:53:47.798][INFO][RK0][main]: Use mixed precision: False
[HCTR][10:53:47.798][INFO][RK0][main]: Use cuda graph: True
[HCTR][10:53:47.798][INFO][RK0][main]: Max batchsize: 64
[HCTR][10:53:47.798][INFO][RK0][main]: Use I64 input key: True
[HCTR][10:53:47.798][INFO][RK0][main]: start create embedding for inference
[HCTR][10:53:47.798][INFO][RK0][main]: sparse_input name wide_data
[HCTR][10:53:47.798][INFO][RK0][main]: sparse_input name deep_data
[HCTR][10:53:47.798][INFO][RK0][main]: create embedding for inference success
[HCTR][10:53:47.798][DEBUG][RK0][main]: [device 0] allocating 0.0003 GB, available 30.4636 
[HCTR][10:53:47.799][INFO][RK0][main]: Inference stage skip BinaryCrossEntropyLoss layer, replaced by Sigmoid layer
[HCTR][10:53:47.799][DEBUG][RK0][main]: [device 0] allocating 0.0128 GB, available 30.4421 
WDL multi-embedding table inference result is [0.011136045679450035, 0.006747737061232328, 0.005509266164153814, 0.0118627417832613, 0.01798960007727146, 0.010030664503574371, 0.02108118124306202, 0.008684462867677212, 0.07753805071115494, 0.011398322880268097]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="load-model-embedding-tables-into-local-rocksdb-as-a-parameter-server">
<h3>Load model embedding tables into local RocksDB as a parameter Server<a class="headerlink" href="#load-model-embedding-tables-into-local-rocksdb-as-a-parameter-server" title="Permalink to this headline"></a></h3>
<p>Create a RocksDB directory with read and write permissions for storing model embedded tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mkdir<span class="w"> </span>-p<span class="w"> </span>-m<span class="w"> </span><span class="m">700</span><span class="w"> </span>/wdl_train/rocksdb
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!python /wdl_train/wdl_predict.py &quot;wdl&quot; &quot;./wdl.json&quot; \
&quot;./wdl_dense_20000.model&quot; \
&quot;./wdl0_sparse_20000.model/,./wdl1_sparse_20000.model&quot; \
&quot;/wdl_train/infer_test.csv&quot; \
&quot;rocksdb&quot;  &quot;/wdl_train/rocksdb&quot;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>wdl multi-embedding table prediction
wdl multi-embedding table prediction network is ./wdl.json
wdl multi-embedding table prediction dense file is ./wdl_dense_20000.model
wdl multi-embedding table prediction sparse files are [&#39;./wdl0_sparse_20000.model/&#39;, &#39;./wdl1_sparse_20000.model&#39;]
wdl multi-embedding table prediction input data path is /wdl_train/infer_test.csv
wdl multi-embedding table prediction input dbtype path is rocksdb
wdl multi-embedding table prediction rocksdb_path path is /wdl_train/rocksdb
[HCTR][10:56:41.546][WARNING][RK0][main]: default_value_for_each_table.size() is not equal to the number of embedding tables
[HCTR][10:56:41.546][INFO][RK0][main]: default_emb_vec_value is not specified using default: 0
[HCTR][10:56:41.546][INFO][RK0][main]: default_emb_vec_value is not specified using default: 0
====================================================HPS Create====================================================
[HCTR][10:56:41.546][INFO][RK0][main]: Creating HashMap CPU database backend...
[HCTR][10:56:41.547][DEBUG][RK0][main]: Created blank database backend in local memory!
[HCTR][10:56:41.547][INFO][RK0][main]: Volatile DB: initial cache rate = 1
[HCTR][10:56:41.547][INFO][RK0][main]: Volatile DB: cache missed embeddings = 0
[HCTR][10:56:41.547][INFO][RK0][main]: Creating RocksDB backend...
[HCTR][10:56:41.547][INFO][RK0][main]: Connecting to RocksDB database...
[HCTR][10:56:41.548][ERROR][RK0][main]: RocksDB /wdl_train/rocksdb: Listing column names failed!
[HCTR][10:56:41.548][INFO][RK0][main]: RocksDB /wdl_train/rocksdb, found column family &quot;default&quot;.
[HCTR][10:56:41.583][INFO][RK0][main]: Connected to RocksDB database!
[HCTR][10:56:41.583][DEBUG][RK0][main]: Created raw model loader in local memory!
[HCTR][10:56:41.583][INFO][RK0][main]: Using Local file system backend.
[HCTR][10:56:42.084][INFO][RK0][main]: Table: hps_et.wdl.sparse_embedding2; cached 664320 / 664320 embeddings in volatile database (HashMapBackend); load: 664320 / 18446744073709551615 (0.00%).
[HCTR][10:56:43.351][INFO][RK0][main]: Table: hps_et.wdl.sparse_embedding2; cached 664320 embeddings in persistent database (RocksDB).
[HCTR][10:56:43.351][INFO][RK0][main]: Using Local file system backend.
[HCTR][10:56:43.693][INFO][RK0][main]: Table: hps_et.wdl.sparse_embedding1; cached 1030499 / 1030499 embeddings in volatile database (HashMapBackend); load: 1030499 / 18446744073709551615 (0.00%).
[HCTR][10:56:45.979][INFO][RK0][main]: Table: hps_et.wdl.sparse_embedding1; cached 1030499 embeddings in persistent database (RocksDB).
[HCTR][10:56:45.985][DEBUG][RK0][main]: Real-time subscribers created!
[HCTR][10:56:45.985][INFO][RK0][main]: Creating embedding cache in device 0.
[HCTR][10:56:45.991][INFO][RK0][main]: Model name: wdl
[HCTR][10:56:45.991][INFO][RK0][main]: Max batch size: 64
[HCTR][10:56:45.991][INFO][RK0][main]: Number of embedding tables: 2
[HCTR][10:56:45.991][INFO][RK0][main]: Use GPU embedding cache: True, cache size percentage: 0.900000
[HCTR][10:56:45.991][INFO][RK0][main]: Use static table: False
[HCTR][10:56:45.991][INFO][RK0][main]: Use I64 input key: True
[HCTR][10:56:45.991][INFO][RK0][main]: Configured cache hit rate threshold: 0.500000
[HCTR][10:56:45.991][INFO][RK0][main]: The size of thread pool: 80
[HCTR][10:56:45.991][INFO][RK0][main]: The size of worker memory pool: 2
[HCTR][10:56:45.991][INFO][RK0][main]: The size of refresh memory pool: 1
[HCTR][10:56:45.991][INFO][RK0][main]: The refresh percentage : 0.000000
[HCTR][10:56:46.953][INFO][RK0][main]: Global seed is 3196997041
[HCTR][10:56:46.956][INFO][RK0][main]: Device to NUMA mapping:
  GPU 0 -&gt;  node 0
[HCTR][10:56:48.005][WARNING][RK0][main]: Peer-to-peer access cannot be fully enabled.
[HCTR][10:56:48.005][DEBUG][RK0][main]: [device 0] allocating 0.0000 GB, available 30.7156 
[HCTR][10:56:48.005][INFO][RK0][main]: Start all2all warmup
[HCTR][10:56:48.005][INFO][RK0][main]: End all2all warmup
[HCTR][10:56:48.006][INFO][RK0][main]: Model name: wdl
[HCTR][10:56:48.006][INFO][RK0][main]: Use mixed precision: False
[HCTR][10:56:48.006][INFO][RK0][main]: Use cuda graph: True
[HCTR][10:56:48.006][INFO][RK0][main]: Max batchsize: 64
[HCTR][10:56:48.006][INFO][RK0][main]: Use I64 input key: True
[HCTR][10:56:48.006][INFO][RK0][main]: start create embedding for inference
[HCTR][10:56:48.006][INFO][RK0][main]: sparse_input name wide_data
[HCTR][10:56:48.006][INFO][RK0][main]: sparse_input name deep_data
[HCTR][10:56:48.006][INFO][RK0][main]: create embedding for inference success
[HCTR][10:56:48.006][DEBUG][RK0][main]: [device 0] allocating 0.0003 GB, available 30.4636 
[HCTR][10:56:48.007][INFO][RK0][main]: Inference stage skip BinaryCrossEntropyLoss layer, replaced by Sigmoid layer
[HCTR][10:56:48.007][DEBUG][RK0][main]: [device 0] allocating 0.0128 GB, available 30.4421 
WDL multi-embedding table inference result is [0.011136045679450035, 0.006747737061232328, 0.005509266164153814, 0.0118627417832613, 0.01798960007727146, 0.010030664503574371, 0.02108118124306202, 0.008684462867677212, 0.07753805071115494, 0.011398322880268097]
[HCTR][10:56:48.571][INFO][RK0][main]: Disconnecting from RocksDB database...
[HCTR][10:56:48.573][INFO][RK0][main]: Disconnected from RocksDB database!
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="continuous_training.html" class="btn btn-neutral float-left" title="HugeCTR Continuous Training" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="news-example.html" class="btn btn-neutral float-right" title="NVIDIA Merlin on Microsoft’s News Dataset (MIND)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: v23.04.00
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../v23.02.00/index.html">v23.02.00</a></dd>
      <dd><a href="hugectr_wdl_prediction.html">v23.04.00</a></dd>
      <dd><a href="../../v23.05.00/index.html">v23.05.00</a></dd>
      <dd><a href="../../v23.05.01/index.html">v23.05.01</a></dd>
      <dd><a href="../../v4.3/index.html">v4.3</a></dd>
      <dd><a href="../../v4.3.1/index.html">v4.3.1</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NVJ1Y1YJHK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-NVJ1Y1YJHK', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>